# EpiStrainDynamics

[![codecov](https://codecov.io/gh/acefa-hubs/EpiStrainDynamics/graph/badge.svg)](https://app.codecov.io/gh/acefa-hubs/EpiStrainDynamics)
[![](https://img.shields.io/badge/lifecycle-stable-brightgreen.svg)](https://lifecycle.r-lib.org/articles/stages.html#stable)
[![Project Status: Active - The project has reached a stable, usable
state and is being actively
developed.](https://www.repostatus.org/badges/latest/active.svg)](https://www.repostatus.org/#active)
[![R-CMD-check](https://github.com/acefa-hubs/EpiStrainDynamics/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/acefa-hubs/EpiStrainDynamics/actions/workflows/R-CMD-check.yaml)

`EpiStrainDynamics` is a statistical modelling framework capable of
inferring trends of multiple pathogens. Estimating the temporal trends
in infectious disease activity is crucial for monitoring disease spread
and the impact of interventions. Surveillance indicators routinely
collected to monitor these trends are often a composite of multiple
pathogens. For example, ‘influenza-like illness’ — routinely monitored
as a proxy for influenza infections — is a symptom definition that could
be caused by a wide range of pathogens, including multiple subtypes of
influenza, SARS-CoV-2, and RSV. Inferred trends from such composite time
series may not reflect the trends of any one of the component pathogens,
each of which can exhibit distinct dynamics. Although many surveillance
systems routinely test a subset of individuals contributing to a
surveillance indicator — providing information on the relative
contribution of the component pathogens — trends may be obscured by
time-varying testing rates or substantial noise in the observation
process.

`EpiStrainDynamics` builds on existing modelling frameworks built to
handle two pathogens, and extends them be to able to:

- infer the trends of any number of pathogens
- fit to time series data of counts (eg, daily number of cases)
- incorporate influenza testing data in which the subtype for influenza
  A samples may be undetermined
- account for day-of-the-week effects in daily data
- include options for fitting penalized splines or random walks
- support additional (optional) correlation structures in the parameters
  describing the smoothness of the penalized splines (or random walks),
  and
- account for additional (optional) sources of noise in the observation
  process.

## Installation

You can install the development version of EpiStrainDynamics from
[GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("acefa-hubs/EpiStrainDynamics")
```

## Using `EpiStrainDynamics`

Detailed instructions can be found on the
[vignette](https://acefa-hubs.github.io/EpiStrainDynamics/articles/Using-EpiStrainDyamics.html).
Here we provide a short overview.

### Step 1: Construct model

Modelling specifications are provided using the
[`construct_model()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/construct_model.md)
function. The correct stan model is then applied based on the
specifications provided.
[`construct_model()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/construct_model.md)
takes these arguments: `method`, `pathogen_structure`,
`smoothing_params`, `dispersion_params`, `pathogen_noise`, and
`dow_effect`.

#### `method`

EpiStrainDynamics has pre-compiled stan models that fit either with
bayesian penalised splines or random walks. These are specified using
the `method` argument of
[`construct_model()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/construct_model.md)
as functions, either with
[`random_walk()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/random_walk.md)
or
[`p_spline()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/p_spline.md).
The penalised spline model has two further options to specify:
`spline_degree` is the polynomial degree of the individual spline
segments used to construct the overall curve (must be a positive whole
number) and `days_per_knot`, which is the number of days for each knot
(must also be a positive whole number).

So we may specify:

``` R
method = random_walk(),
# OR
method = p_spline(spline_degree = 3, days_per_knot = 2)
```

## Pathogen structure

There are three main types of pathogen structure available to model:
[`single()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/single.md),
[`multiple()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/multiple.md),
and
[`subtyped()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/subtyped.md).
These functions require the name of the dataset itself and the column
names for different data elements.

The
[`single()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/single.md)
pathogen structure is the simplest and models a single pathogen
timeseries. The user must specify the dataset name, the name of the
column with total case data, and the name of the column of time data.
The
[`multiple()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/multiple.md)
pathogen structure allows modelling of different component pathogens. In
addition to specifying the dataset, total case data, and time, the
additional pathogens are specified as a vector of column names. The
[`subtyped()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/subtyped.md)
pathogen structure enables additional complexity, specifically for an
influenza modelling scenario, by allowing the user to incorporate
testing data for influenza A subtypes. The user specifies columns
containing the unsubtyped influenza A case count as well as the subtyped
influenza A cases, and any additional pathogens to be modelled. See the
vignette for further detail.

## Smoothing parameters

The argument `smoothing_params` allows users to modify the correlation
structures in the parameters describing smoothness and to set related
priors. These are specified with the function
[`smoothing_structure()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/smoothing_structure.md),
which requires the user to specify a `smoothing_type` that is either
`shared` (all pathogens have the same smoothing parameter),
`independent` (each pathogen has a completely independent smoothing
parameter), or `correlated` (smoothing structure is correlated among
pathogens). For smoothign types `shared` and `independent` the priors
for the mean and standard deviation on tau can also be specified. The
number of values specified for each parameter depend on how many
pathogens are provided. As below:

``` R
smoothing_structure(
  smoothing_type = 'shared',
  tau_mean = 0, tau_sd = 1
)
# for a model with 4 parameters:
smoothing_structure(
  smoothing_type = 'independent',
  tau_mean = c(0, 0, 0, 0),
  tau_sd = c(1, 1, 1, 1)
)
```

## Dispersion parameters

The argument `dispersion_params` optionally allows users to set a prior
for the overdispersion parameter of the negative binomial likelihood for
the case timeseries. If specified, each parameter only ever needs a
single value. It is specified using
[`dispersion_structure()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/dispersion_structure.md)
as below:

``` R
dispersion_structure(
  phi_mean = 0, phi_sd = 1
)
```

## Pathogen noise

A logical (`TRUE` or `FALSE`) value indicating whether to include noise
between individual pathogens in addition to the observation noise.

## Day of week effect

Day of week effect is specified as a logical (`TRUE` or `FALSE`) to the
`dow_effect` argument. In plotting, the day of week effect can be
selectively removed.

## Example

Altogether, an example constructed model for a random walk model with
multiple pathogens might look as follows, illustrated using data that
has been provided with the package - `sarscov2`:

``` R
mod <- construct_model(
  method = random_walk(),                   # random_walk method
  
  pathogen_structure = multiple(            # multiple pathogen structure
   data = sarscov2,
   case_timeseries = 'cases',               # timeseries of case data
   time = 'date',                           # date or time variable labels
   component_pathogen_timeseries = c(       # component pathogens
     'alpha', 'delta', 'omicron', 'other'
   )
  ),
   
  smoothing_params = smoothing_structure(   # independent smoothing structure 
    'independent',                          # with four values for each prior
    tau_mean = c(0, 0.1, 0.3, 0),           # parameter - one for each pathogen
    tau_sd = rep(1, times = 4)
  ),
  dispersion_params = dispersion_structure(phi_mean = 0, phi_sd = 1),
  pathogen_noise = FALSE,
  dow_effect = TRUE
)
```

### Step 2: fit model

The model estimates the expected value of the time series (eg, a
smoothed trend in the daily number of cases accounting for noise) for
each individual pathogen. In this step additional fitting parameters
related to stan models can be modified such as `n_chain`, `n_iter`,
`n_warmup`, `thin`, `adapt_delta`, `multi_cores`, `verbose`, and `seed`,
which are described in further detail in the documentation. Model
parameterisation decisions specified when constructing the model in step
1 mean the correct stan model will be applied at this stage by simply
calling:

``` R
fit <- fit_model(mod)
```

### Step 3: Calculate and visualise epidemiological quantities

Calculate epidemic growth rate with `growth_rate(fit)`, effective
reproduction number over time with `Rt(fit, gi_dist = X)` (requiring
specification of a generation interval distribution X), incidence with
or without a day of week effect with
`incidence(fit, dow_effect = TRUE)`, and proportions of different
combinations of cases attributable to different pathogens/subtypes using
[`proportion()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/proportion.md).

``` R
prop <- proportion(fit)
plot(prop)
```

For a more detailed discussion, check out the
[vignette](https://acefa-hubs.github.io/EpiStrainDynamics/articles/Using-EpiStrainDyamics.html).

## Citation

When using this package, please cite both the package and the research
article underlying the statistical model developments:

Windecker S, Eales O (2025). EpiStrainDynamics: Infer temporal trends of
multiple pathogens. R package version 0.0.0.9000,
<https://acefa-hubs.github.io/EpiStrainDynamics/>.

Oliver Eales, Saras M Windecker, James M McCaw, Freya M Shearer,
Inferring temporal trends of multiple pathogens, variants, subtypes or
serotypes from routine surveillance data, American Journal of
Epidemiology, 2025;, kwaf119, <https://doi.org/10.1093/aje/kwaf119>

For code corresponding to the AJE paper, see branch
[`paper_analysis`](https://github.com/acefa-hubs/EpiStrainDynamics/tree/paper_analysis).

## Contribution

This is a work in progress. If you see any mistakes in the package
(branch `main`) or in the code associated with the analyses for the
paper (branch `paper_analysis`), let us know by logging a bug on the
[issues](https://github.com/acefa-hubs/EpiStrainDynamics/issues) page.

## Code of Conduct

Please note that the `EpiStrainDynamics` project is released with a
[Contributor Code of
Conduct](https://acefa-hubs.github.io/EpiStrainDynamics/CODE_OF_CONDUCT.html).
By contributing to this project, you agree to abide by its terms.

## Support

This project was supported by the Australia-Aotearoa Consortium for
Epidemic Forecasting and Analytics.

[![EpiStrainDynamics
website](reference/figures/ACEFA.png)](https://acefa-hubs.github.io/)

# Package index

## Data

Datasets incorporated in the package for demonstration.

- [`influenza`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/influenza.md)
  : World Health Organisation Global Influenza Programme for Australia
- [`sarscov2`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/sarscov2.md)
  : United Kingdom Health Security Agency SARS-CoV-2 case data

## Construct model functions

Functions for constructing model object.

- [`p_spline()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/p_spline.md)
  : Specify p_spline method
- [`random_walk()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/random_walk.md)
  : Specify random walk method
- [`single()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/single.md)
  : Single pathogen structure
- [`multiple()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/multiple.md)
  : Multiple pathogen structure
- [`subtyped()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/subtyped.md)
  : Subtyped pathogen structure
- [`smoothing_structure()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/smoothing_structure.md)
  : Create Smoothing Structure Specification with Priors
- [`dispersion_structure()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/dispersion_structure.md)
  : Create Dispersion Structure Specification
- [`construct_model()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/construct_model.md)
  : Construct model

## Fit stan model

- [`fit_model()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/fit_model.md)
  : Generic Method for fitting model
- [`diagnose_model()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/diagnose_model.md)
  : Diagnose model convergence and fit

## Post-modelling metrics calculations

Functions to calculate and plot metrics from fitted models.

- [`Rt()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/Rt.md)
  : Generic Method for Rt Analysis
- [`growth_rate()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/growth_rate.md)
  : Generic Method for Growth Rate Analysis
- [`incidence()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/incidence.md)
  : Generic Method for Incidence Analysis
- [`proportion()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/proportion.md)
  : Generic Method for proportion Analysis
- [`plot()`](https://acefa-hubs.github.io/EpiStrainDynamics/reference/plot.md)
  : Generic Method for plotting metrics calculation outputs

# Articles

### Statistical Properties

- [Using
  EpiStrainDynamics](https://acefa-hubs.github.io/EpiStrainDynamics/articles/Using-EpiStrainDynamics.md):
- [Algorithmic Scaling and Statistical
  Properties](https://acefa-hubs.github.io/EpiStrainDynamics/articles/algorithmic-scaling.md):
- [Parameter Recovery
  Tests](https://acefa-hubs.github.io/EpiStrainDynamics/articles/parameter-recovery.md):
