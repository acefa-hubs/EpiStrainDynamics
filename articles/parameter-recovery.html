<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Parameter Recovery Tests â€¢ EpiStrainDynamics</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Parameter Recovery Tests">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">EpiStrainDynamics</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Using-EpiStrainDynamics.html">Using EpiStrainDynamics</a></li>
    <li><a class="dropdown-item" href="../articles/algorithmic-scaling.html">Algorithmic Scaling and Statistical Properties</a></li>
    <li><a class="dropdown-item" href="../articles/parameter-recovery.html">Parameter Recovery Tests</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/acefa-hubs/EpiStrainDynamics/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Parameter Recovery Tests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/acefa-hubs/EpiStrainDynamics/blob/main/vignettes/articles/parameter-recovery.Rmd" class="external-link"><code>vignettes/articles/parameter-recovery.Rmd</code></a></small>
      <div class="d-none name"><code>parameter-recovery.Rmd</code></div>
    </div>

    
    
<p>This document demonstrates parameter recovery properties of
<code>EpiStrainDynamics</code> models, addressing the following
statistical software standards:</p>
<ul>
<li>Parameter recovery tests with data of known properties</li>
<li>Recovery within defined tolerance rather than exact values</li>
<li>Multiple random seeds when algorithm contains random component</li>
</ul>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>Parameter recovery tests verify that when we generate synthetic data
with <strong>known true parameters</strong>, the model can successfully
recover those parameters. This is a fundamental validation that the
statistical model is correctly specified and the inference algorithm
works as intended.</p>
<p>We test recovery of:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Pathogen proportions over time</strong> - the relative
contribution of each pathogen</li>
<li>
<strong>Smoothing parameters</strong> - controlling the smoothness
of temporal trends</li>
<li>
<strong>Overall temporal patterns</strong> - the shape and dynamics
of the epidemic curves</li>
</ol>
<hr>
</div>
<div class="section level2">
<h2 id="single-pathogen-parameter-recovery">1. Single Pathogen Parameter Recovery<a class="anchor" aria-label="anchor" href="#single-pathogen-parameter-recovery"></a>
</h2>
<p>We start with the simplest case: a single pathogen with known
temporal dynamics.</p>
<div class="section level3">
<h3 id="generate-data-with-known-trend">1.1 Generate Data with Known Trend<a class="anchor" aria-label="anchor" href="#generate-data-with-known-trend"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_timepoints</span> <span class="op">&lt;-</span> <span class="fl">90</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html" class="external-link">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-01-01"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"day"</span>, length.out <span class="op">=</span> <span class="va">n_timepoints</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a known smooth trend (combination of sine waves)</span></span>
<span><span class="va">time_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">*</span><span class="va">pi</span>, length.out <span class="op">=</span> <span class="va">n_timepoints</span><span class="op">)</span></span>
<span><span class="va">true_lambda</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="op">+</span> <span class="fl">50</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">time_index</span><span class="op">)</span> <span class="op">+</span> <span class="fl">30</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">time_index</span> <span class="op">*</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate observed counts with overdispersion</span></span>
<span><span class="va">true_phi</span> <span class="op">&lt;-</span> <span class="fl">3.0</span>  <span class="co"># Known dispersion parameter</span></span>
<span><span class="va">observed_cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom</a></span><span class="op">(</span><span class="va">n_timepoints</span>, mu <span class="op">=</span> <span class="va">true_lambda</span>, size <span class="op">=</span> <span class="va">true_phi</span><span class="op">)</span></span>
<span></span>
<span><span class="va">single_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  date <span class="op">=</span> <span class="va">dates</span>,</span>
<span>  cases <span class="op">=</span> <span class="va">observed_cases</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Store true values for comparison</span></span>
<span><span class="va">true_values_single</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  date <span class="op">=</span> <span class="va">dates</span>,</span>
<span>  true_mean <span class="op">=</span> <span class="va">true_lambda</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-model-with-multiple-seeds">1.2 Fit Model with Multiple Seeds<a class="anchor" aria-label="anchor" href="#fit-model-with-multiple-seeds"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seeds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">111</span>, <span class="fl">222</span><span class="op">)</span></span>
<span><span class="va">single_fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">seeds</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Fitting with seed"</span>, <span class="va">seeds</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/construct_model.html">construct_model</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="fu"><a href="../reference/random_walk.html">random_walk</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    pathogen_structure <span class="op">=</span> <span class="fu"><a href="../reference/single.html">single</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">single_data</span>,</span>
<span>      case_timeseries <span class="op">=</span> <span class="st">'cases'</span>,</span>
<span>      time <span class="op">=</span> <span class="st">'date'</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">model</span>, n_chain <span class="op">=</span> <span class="fl">2</span>, n_iter <span class="op">=</span> <span class="fl">2000</span>, </span>
<span>                   seed <span class="op">=</span> <span class="va">seeds</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">inc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/incidence.html">incidence</a></span><span class="op">(</span><span class="va">fit</span>, dow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">inc_single</span> <span class="op">&lt;-</span> <span class="va">inc</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span></span>
<span>  </span>
<span>  <span class="va">single_fits</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    seed <span class="op">=</span> <span class="va">seeds</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>    median <span class="op">=</span> <span class="va">inc</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span>,</span>
<span>    lower <span class="op">=</span> <span class="va">inc</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">lb_95</span>,</span>
<span>    upper <span class="op">=</span> <span class="va">inc</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">ub_95</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Fitting with seed 111</span></span>
<span><span class="co">#&gt; Fitting with seed 222</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="evaluate-recovery">1.3 Evaluate Recovery<a class="anchor" aria-label="anchor" href="#evaluate-recovery"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate metrics for each seed</span></span>
<span><span class="va">recovery_metrics_single</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  seed <span class="op">=</span> <span class="va">seeds</span>,</span>
<span>  correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">single_fits</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">median</span>, <span class="va">true_lambda</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">single_fits</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">median</span> <span class="op">-</span> <span class="va">true_lambda</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  relative_rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">single_fits</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">median</span> <span class="op">-</span> <span class="va">true_lambda</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">true_lambda</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span>,</span>
<span>  coverage_95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">single_fits</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">true_lambda</span> <span class="op">&gt;=</span> <span class="va">x</span><span class="op">$</span><span class="va">lower</span> <span class="op">&amp;</span> <span class="va">true_lambda</span> <span class="op">&lt;=</span> <span class="va">x</span><span class="op">$</span><span class="va">upper</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">recovery_metrics_single</span>, digits <span class="op">=</span> <span class="fl">4</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Single pathogen parameter recovery metrics across seeds"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Single pathogen parameter recovery metrics across
seeds</caption>
<thead><tr class="header">
<th align="right">seed</th>
<th align="right">correlation</th>
<th align="right">rmse</th>
<th align="right">relative_rmse</th>
<th align="right">coverage_95</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">111</td>
<td align="right">0.8589</td>
<td align="right">22.9200</td>
<td align="right">0.2284</td>
<td align="right">0.8000</td>
</tr>
<tr class="even">
<td align="right">222</td>
<td align="right">0.8611</td>
<td align="right">22.6868</td>
<td align="right">0.2261</td>
<td align="right">0.8111</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nSummary across seeds:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary across seeds:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Mean correlation:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">recovery_metrics_single</span><span class="op">$</span><span class="va">correlation</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Mean correlation: 0.86</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Mean relative RMSE:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">recovery_metrics_single</span><span class="op">$</span><span class="va">relative_rmse</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Mean relative RMSE: 0.2273</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Mean 95% CI coverage:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">recovery_metrics_single</span><span class="op">$</span><span class="va">coverage_95</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Mean 95% CI coverage: 0.8056</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot first seed results</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  date <span class="op">=</span> <span class="va">dates</span>,</span>
<span>  true <span class="op">=</span> <span class="va">true_lambda</span>,</span>
<span>  estimated <span class="op">=</span> <span class="va">single_fits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">median</span>,</span>
<span>  lower <span class="op">=</span> <span class="va">single_fits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">lower</span>,</span>
<span>  upper <span class="op">=</span> <span class="va">single_fits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">upper</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span>, fill <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">true</span>, color <span class="op">=</span> <span class="st">"True"</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimated</span>, color <span class="op">=</span> <span class="st">"Estimated"</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"True"</span> <span class="op">=</span> <span class="st">"black"</span>, <span class="st">"Estimated"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Single Pathogen Parameter Recovery"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"True mean vs estimated incidence with 95% credible interval"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Cases"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="parameter-recovery_files/figure-html/plot-single-recovery-1.png" class="r-plt" width="672"></p>
<p><strong>Interpretation</strong>: High correlation (&gt;0.95) and good
credible interval coverage (near 0.95) indicate successful recovery of
the true temporal pattern.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="multiple-pathogen-parameter-recovery">2. Multiple Pathogen Parameter Recovery<a class="anchor" aria-label="anchor" href="#multiple-pathogen-parameter-recovery"></a>
</h2>
<p>Now test recovery of multiple pathogen proportions that vary over
time.</p>
<div class="section level3">
<h3 id="generate-data-with-known-pathogen-dynamics">2.1 Generate Data with Known Pathogen Dynamics<a class="anchor" aria-label="anchor" href="#generate-data-with-known-pathogen-dynamics"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_timepoints</span> <span class="op">&lt;-</span> <span class="fl">120</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html" class="external-link">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-01-01"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"day"</span>, length.out <span class="op">=</span> <span class="va">n_timepoints</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create time-varying proportions for 3 pathogens</span></span>
<span><span class="va">time_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_timepoints</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pathogen 1: rises then falls</span></span>
<span><span class="va">prop1</span> <span class="op">&lt;-</span> <span class="fl">0.3</span> <span class="op">+</span> <span class="fl">0.4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">time_seq</span>, mean <span class="op">=</span> <span class="fl">0.3</span>, sd <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pathogen 2: falls then rises  </span></span>
<span><span class="va">prop2</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">-</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="va">time_seq</span></span>
<span></span>
<span><span class="co"># Pathogen 3: fills the remainder</span></span>
<span><span class="va">prop3</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">prop1</span> <span class="op">-</span> <span class="va">prop2</span></span>
<span></span>
<span><span class="co"># Ensure all proportions are non-negative</span></span>
<span><span class="va">prop1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">prop1</span><span class="op">)</span></span>
<span><span class="va">prop2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">prop2</span><span class="op">)</span></span>
<span><span class="va">prop3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">prop3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Normalize to ensure they sum to exactly 1</span></span>
<span><span class="va">total</span> <span class="op">&lt;-</span> <span class="va">prop1</span> <span class="op">+</span> <span class="va">prop2</span> <span class="op">+</span> <span class="va">prop3</span></span>
<span><span class="va">true_proportions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  pathogen1 <span class="op">=</span> <span class="va">prop1</span> <span class="op">/</span> <span class="va">total</span>,</span>
<span>  pathogen2 <span class="op">=</span> <span class="va">prop2</span> <span class="op">/</span> <span class="va">total</span>,</span>
<span>  pathogen3 <span class="op">=</span> <span class="va">prop3</span> <span class="op">/</span> <span class="va">total</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate total cases</span></span>
<span><span class="va">total_cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="va">n_timepoints</span>, lambda <span class="op">=</span> <span class="fl">150</span> <span class="op">+</span> <span class="fl">30</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">*</span><span class="va">pi</span>, length.out <span class="op">=</span> <span class="va">n_timepoints</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Allocate to pathogens</span></span>
<span><span class="va">pathogen_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">n_timepoints</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_timepoints</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pathogen_counts</span><span class="op">[</span><span class="va">t</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></span><span class="op">(</span><span class="fl">1</span>, size <span class="op">=</span> <span class="va">total_cases</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>, </span>
<span>                                               prob <span class="op">=</span> <span class="va">true_proportions</span><span class="op">[</span><span class="va">t</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">multiple_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  date <span class="op">=</span> <span class="va">dates</span>,</span>
<span>  cases <span class="op">=</span> <span class="va">total_cases</span>,</span>
<span>  pathogen1 <span class="op">=</span> <span class="va">pathogen_counts</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>  pathogen2 <span class="op">=</span> <span class="va">pathogen_counts</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>  pathogen3 <span class="op">=</span> <span class="va">pathogen_counts</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-model-with-multiple-seeds-1">2.2 Fit Model with Multiple Seeds<a class="anchor" aria-label="anchor" href="#fit-model-with-multiple-seeds-1"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seeds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">555</span>, <span class="fl">666</span><span class="op">)</span></span>
<span><span class="va">multiple_fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">seeds</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Fitting with seed"</span>, <span class="va">seeds</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/construct_model.html">construct_model</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="fu"><a href="../reference/random_walk.html">random_walk</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    pathogen_structure <span class="op">=</span> <span class="fu"><a href="../reference/multiple.html">multiple</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">multiple_data</span>,</span>
<span>      case_timeseries <span class="op">=</span> <span class="st">'cases'</span>,</span>
<span>      time <span class="op">=</span> <span class="st">'date'</span>,</span>
<span>      component_pathogen_timeseries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'pathogen1'</span>, <span class="st">'pathogen2'</span>, <span class="st">'pathogen3'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">model</span>, n_chain <span class="op">=</span> <span class="fl">2</span>, n_iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>                   seed <span class="op">=</span> <span class="va">seeds</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">props</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/proportion.html">proportion</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">multiple_fits</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    seed <span class="op">=</span> <span class="va">seeds</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>    proportions <span class="op">=</span> <span class="va">props</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Fitting with seed 555</span></span>
<span><span class="co">#&gt; Fitting with seed 666</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="evaluate-proportion-recovery">2.3 Evaluate Proportion Recovery<a class="anchor" aria-label="anchor" href="#evaluate-proportion-recovery"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate recovery metrics for each pathogen and seed</span></span>
<span><span class="va">recovery_metrics_multiple</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">seeds</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">props_est</span> <span class="op">&lt;-</span> <span class="va">multiple_fits</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">proportions</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">pathogen</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pathogen1"</span>, <span class="st">"pathogen2"</span>, <span class="st">"pathogen3"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">true_prop</span> <span class="op">&lt;-</span> <span class="va">true_proportions</span><span class="op">[</span>, <span class="va">pathogen</span><span class="op">]</span></span>
<span>    <span class="va">est_prop</span> <span class="op">&lt;-</span> <span class="va">props_est</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">props_est</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">pathogen</span> <span class="op">==</span> <span class="va">pathogen</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="va">recovery_metrics_multiple</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">recovery_metrics_multiple</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      seed <span class="op">=</span> <span class="va">seeds</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      pathogen <span class="op">=</span> <span class="va">pathogen</span>,</span>
<span>      correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">true_prop</span>, <span class="va">est_prop</span><span class="op">)</span>,</span>
<span>      rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">est_prop</span> <span class="op">-</span> <span class="va">true_prop</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      mean_absolute_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">est_prop</span> <span class="op">-</span> <span class="va">true_prop</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Summary by pathogen</span></span>
<span><span class="va">summary_by_pathogen</span> <span class="op">&lt;-</span> <span class="va">recovery_metrics_multiple</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">pathogen</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarise</span><span class="op">(</span></span>
<span>    mean_correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">correlation</span><span class="op">)</span>,</span>
<span>    mean_rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">rmse</span><span class="op">)</span>,</span>
<span>    mean_mae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mean_absolute_error</span><span class="op">)</span>,</span>
<span>    sd_correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">correlation</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">summary_by_pathogen</span>, digits <span class="op">=</span> <span class="fl">4</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Multiple pathogen proportion recovery summary across seeds"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Multiple pathogen proportion recovery summary across
seeds</caption>
<thead><tr class="header">
<th align="left">pathogen</th>
<th align="right">mean_correlation</th>
<th align="right">mean_rmse</th>
<th align="right">mean_mae</th>
<th align="right">sd_correlation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">pathogen1</td>
<td align="right">0.9949</td>
<td align="right">0.0191</td>
<td align="right">0.0153</td>
<td align="right">0.0003</td>
</tr>
<tr class="even">
<td align="left">pathogen2</td>
<td align="right">0.9677</td>
<td align="right">0.0179</td>
<td align="right">0.0147</td>
<td align="right">0.0045</td>
</tr>
<tr class="odd">
<td align="left">pathogen3</td>
<td align="right">0.9960</td>
<td align="right">0.0184</td>
<td align="right">0.0115</td>
<td align="right">0.0002</td>
</tr>
</tbody>
</table>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="p-spline-method-comparison">3. P-Spline Method Comparison<a class="anchor" aria-label="anchor" href="#p-spline-method-comparison"></a>
</h2>
<p>Test whether the p-spline method also successfully recovers
parameters.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use the same multiple pathogen data</span></span>
<span><span class="va">model_ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/construct_model.html">construct_model</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="fu"><a href="../reference/p_spline.html">p_spline</a></span><span class="op">(</span>spline_degree <span class="op">=</span> <span class="fl">3</span>, days_per_knot <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>  pathogen_structure <span class="op">=</span> <span class="fu"><a href="../reference/multiple.html">multiple</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">multiple_data</span>,</span>
<span>    case_timeseries <span class="op">=</span> <span class="st">'cases'</span>,</span>
<span>    time <span class="op">=</span> <span class="st">'date'</span>,</span>
<span>    component_pathogen_timeseries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'pathogen1'</span>, <span class="st">'pathogen2'</span>, <span class="st">'pathogen3'</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">model_ps</span>, n_chain <span class="op">=</span> <span class="fl">2</span>, n_iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>                    seed <span class="op">=</span> <span class="fl">999</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">props_ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/proportion.html">proportion</a></span><span class="op">(</span><span class="va">fit_ps</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract proportions for each pathogen</span></span>
<span><span class="va">prop1</span> <span class="op">&lt;-</span> <span class="va">props_ps</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">props_ps</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">pathogen</span> <span class="op">==</span> <span class="st">"pathogen1"</span><span class="op">]</span></span>
<span><span class="va">prop2</span> <span class="op">&lt;-</span> <span class="va">props_ps</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">props_ps</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">pathogen</span> <span class="op">==</span> <span class="st">"pathogen2"</span><span class="op">]</span></span>
<span><span class="va">prop3</span> <span class="op">&lt;-</span> <span class="va">props_ps</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">props_ps</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">pathogen</span> <span class="op">==</span> <span class="st">"pathogen3"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Calculate recovery metrics</span></span>
<span><span class="va">ps_recovery</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  pathogen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pathogen1"</span>, <span class="st">"pathogen2"</span>, <span class="st">"pathogen3"</span><span class="op">)</span>,</span>
<span>  correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">true_proportions</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">prop1</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">true_proportions</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">prop2</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">true_proportions</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span>, <span class="va">prop3</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">prop1</span> <span class="op">-</span> <span class="va">true_proportions</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">prop2</span> <span class="op">-</span> <span class="va">true_proportions</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">prop3</span> <span class="op">-</span> <span class="va">true_proportions</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ps_recovery</span>, digits <span class="op">=</span> <span class="fl">4</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"P-spline method parameter recovery"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>P-spline method parameter recovery</caption>
<thead><tr class="header">
<th align="left">pathogen</th>
<th align="right">correlation</th>
<th align="right">rmse</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">pathogen1</td>
<td align="right">0.9968</td>
<td align="right">0.0152</td>
</tr>
<tr class="even">
<td align="left">pathogen2</td>
<td align="right">0.9500</td>
<td align="right">0.0222</td>
</tr>
<tr class="odd">
<td align="left">pathogen3</td>
<td align="right">0.9947</td>
<td align="right">0.0210</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare random walk vs p-spline for pathogen 1</span></span>
<span><span class="va">rw_props</span> <span class="op">&lt;-</span> <span class="va">multiple_fits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">proportions</span></span>
<span></span>
<span><span class="co"># Extract proportions for each method</span></span>
<span><span class="va">rw_prop1</span> <span class="op">&lt;-</span> <span class="va">rw_props</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">rw_props</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">pathogen</span> <span class="op">==</span> <span class="st">"pathogen1"</span><span class="op">]</span></span>
<span><span class="va">ps_prop1</span> <span class="op">&lt;-</span> <span class="va">props_ps</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">props_ps</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">pathogen</span> <span class="op">==</span> <span class="st">"pathogen1"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Create separate vectors for each method</span></span>
<span><span class="va">comparison_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">dates</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"true"</span>, <span class="st">"random_walk"</span>, <span class="st">"p_spline"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  proportion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">true_proportions</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    <span class="va">rw_prop1</span>,</span>
<span>    <span class="va">ps_prop1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">comparison_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">proportion</span>, color <span class="op">=</span> <span class="va">method</span>, linetype <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"true"</span> <span class="op">=</span> <span class="st">"black"</span>, <span class="st">"random_walk"</span> <span class="op">=</span> <span class="st">"blue"</span>, <span class="st">"p_spline"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_linetype_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"true"</span> <span class="op">=</span> <span class="st">"solid"</span>, <span class="st">"random_walk"</span> <span class="op">=</span> <span class="st">"dashed"</span>, <span class="st">"p_spline"</span> <span class="op">=</span> <span class="st">"dotted"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Method Comparison: Random Walk vs P-Spline"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Recovery of Pathogen 1 proportion"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Proportion"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Method"</span>,</span>
<span>    linetype <span class="op">=</span> <span class="st">"Method"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="parameter-recovery_files/figure-html/compare-methods-1.png" class="r-plt" width="672"></p>
<hr>
</div>
<div class="section level2">
<h2 id="subtyped-pathogen-structure-recovery">4. Subtyped Pathogen Structure Recovery<a class="anchor" aria-label="anchor" href="#subtyped-pathogen-structure-recovery"></a>
</h2>
<p>Test recovery with the more complex subtyped structure (e.g.,
influenza with subtypes).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2024</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_timepoints</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.Date.html" class="external-link">seq.Date</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-01-01"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"day"</span>, length.out <span class="op">=</span> <span class="va">n_timepoints</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create proportions for: H3N2, H1N1, inf_B, other</span></span>
<span><span class="va">time_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n_timepoints</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># H3N2 dominant early</span></span>
<span><span class="va">prop_h3n2</span> <span class="op">&lt;-</span> <span class="fl">0.4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span> <span class="op">*</span> <span class="va">time_seq</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># H1N1 rises mid-season</span></span>
<span><span class="va">prop_h1n1</span> <span class="op">&lt;-</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">time_seq</span>, mean <span class="op">=</span> <span class="fl">0.5</span>, sd <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inf B late season</span></span>
<span><span class="va">prop_infB</span> <span class="op">&lt;-</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span> <span class="op">*</span> <span class="op">(</span><span class="va">time_seq</span> <span class="op">-</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Other fills remainder</span></span>
<span><span class="va">prop_other</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">prop_h3n2</span> <span class="op">-</span> <span class="va">prop_h1n1</span> <span class="op">-</span> <span class="va">prop_infB</span></span>
<span></span>
<span><span class="co"># Ensure non-negative and normalize</span></span>
<span><span class="va">true_props_subtyped</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  h3n2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">prop_h3n2</span><span class="op">)</span>,</span>
<span>  h1n1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">prop_h1n1</span><span class="op">)</span>,</span>
<span>  infB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">prop_infB</span><span class="op">)</span>,</span>
<span>  other <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">prop_other</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">true_props_subtyped</span> <span class="op">&lt;-</span> <span class="va">true_props_subtyped</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">true_props_subtyped</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate total ILI</span></span>
<span><span class="va">total_ili</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="va">n_timepoints</span>, lambda <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate inf_A (sum of H3N2 and H1N1)</span></span>
<span><span class="va">inf_A_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n_timepoints</span>, size <span class="op">=</span> <span class="va">total_ili</span>, </span>
<span>                       prob <span class="op">=</span> <span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"h3n2"</span><span class="op">]</span> <span class="op">+</span> <span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"h1n1"</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Allocate inf_A to subtypes</span></span>
<span><span class="va">subtyped_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="va">n_timepoints</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_timepoints</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Split inf_A into H3N2 and H1N1</span></span>
<span>  <span class="va">prop_h3n2_given_A</span> <span class="op">&lt;-</span> <span class="va">true_props_subtyped</span><span class="op">[</span><span class="va">t</span>, <span class="st">"h3n2"</span><span class="op">]</span> <span class="op">/</span> </span>
<span>    <span class="op">(</span><span class="va">true_props_subtyped</span><span class="op">[</span><span class="va">t</span>, <span class="st">"h3n2"</span><span class="op">]</span> <span class="op">+</span> <span class="va">true_props_subtyped</span><span class="op">[</span><span class="va">t</span>, <span class="st">"h1n1"</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1e-10</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">subtyped_counts</span><span class="op">[</span><span class="va">t</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, size <span class="op">=</span> <span class="va">inf_A_counts</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>, prob <span class="op">=</span> <span class="va">prop_h3n2_given_A</span><span class="op">)</span></span>
<span>  <span class="va">subtyped_counts</span><span class="op">[</span><span class="va">t</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">inf_A_counts</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">-</span> <span class="va">subtyped_counts</span><span class="op">[</span><span class="va">t</span>, <span class="fl">1</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Remaining cases split between inf_B and other</span></span>
<span>  <span class="va">remaining</span> <span class="op">&lt;-</span> <span class="va">total_ili</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">-</span> <span class="va">inf_A_counts</span><span class="op">[</span><span class="va">t</span><span class="op">]</span></span>
<span>  <span class="va">prop_infB_given_remaining</span> <span class="op">&lt;-</span> <span class="va">true_props_subtyped</span><span class="op">[</span><span class="va">t</span>, <span class="st">"infB"</span><span class="op">]</span> <span class="op">/</span> </span>
<span>    <span class="op">(</span><span class="va">true_props_subtyped</span><span class="op">[</span><span class="va">t</span>, <span class="st">"infB"</span><span class="op">]</span> <span class="op">+</span> <span class="va">true_props_subtyped</span><span class="op">[</span><span class="va">t</span>, <span class="st">"other"</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1e-10</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">subtyped_counts</span><span class="op">[</span><span class="va">t</span>, <span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, size <span class="op">=</span> <span class="va">remaining</span>, prob <span class="op">=</span> <span class="va">prop_infB_given_remaining</span><span class="op">)</span></span>
<span>  <span class="va">subtyped_counts</span><span class="op">[</span><span class="va">t</span>, <span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">remaining</span> <span class="op">-</span> <span class="va">subtyped_counts</span><span class="op">[</span><span class="va">t</span>, <span class="fl">3</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">subtyped_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  week <span class="op">=</span> <span class="va">dates</span>,</span>
<span>  ili <span class="op">=</span> <span class="va">total_ili</span>,</span>
<span>  inf_A <span class="op">=</span> <span class="va">inf_A_counts</span>,</span>
<span>  inf_H3N2 <span class="op">=</span> <span class="va">subtyped_counts</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>  inf_H1N1 <span class="op">=</span> <span class="va">subtyped_counts</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>  inf_B <span class="op">=</span> <span class="va">subtyped_counts</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span>,</span>
<span>  other <span class="op">=</span> <span class="va">subtyped_counts</span><span class="op">[</span>, <span class="fl">4</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_subtyped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/construct_model.html">construct_model</a></span><span class="op">(</span></span>
<span>  method <span class="op">=</span> <span class="fu"><a href="../reference/random_walk.html">random_walk</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  pathogen_structure <span class="op">=</span> <span class="fu"><a href="../reference/subtyped.html">subtyped</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">subtyped_data</span>,</span>
<span>    case_timeseries <span class="op">=</span> <span class="st">'ili'</span>,</span>
<span>    time <span class="op">=</span> <span class="st">'week'</span>,</span>
<span>    influenzaA_unsubtyped_timeseries <span class="op">=</span> <span class="st">'inf_A'</span>,</span>
<span>    influenzaA_subtyped_timeseries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'inf_H3N2'</span>, <span class="st">'inf_H1N1'</span><span class="op">)</span>,</span>
<span>    other_pathogen_timeseries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'inf_B'</span>, <span class="st">'other'</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_subtyped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">model_subtyped</span>, n_chain <span class="op">=</span> <span class="fl">2</span>, n_iter <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>                          seed <span class="op">=</span> <span class="fl">12345</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">props_subtyped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/proportion.html">proportion</a></span><span class="op">(</span><span class="va">fit_subtyped</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract proportions for each pathogen</span></span>
<span><span class="va">prop_h3n2</span> <span class="op">&lt;-</span> <span class="va">props_subtyped</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">props_subtyped</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">pathogen</span> <span class="op">==</span> <span class="st">"inf_H3N2"</span><span class="op">]</span></span>
<span><span class="va">prop_h1n1</span> <span class="op">&lt;-</span> <span class="va">props_subtyped</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">props_subtyped</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">pathogen</span> <span class="op">==</span> <span class="st">"inf_H1N1"</span><span class="op">]</span></span>
<span><span class="va">prop_infB</span> <span class="op">&lt;-</span> <span class="va">props_subtyped</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">props_subtyped</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">pathogen</span> <span class="op">==</span> <span class="st">"inf_B"</span><span class="op">]</span></span>
<span><span class="va">prop_other</span> <span class="op">&lt;-</span> <span class="va">props_subtyped</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">props_subtyped</span><span class="op">$</span><span class="va">measure</span><span class="op">$</span><span class="va">pathogen</span> <span class="op">==</span> <span class="st">"other"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Calculate recovery metrics</span></span>
<span><span class="va">subtyped_recovery</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  pathogen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"inf_H3N2"</span>, <span class="st">"inf_H1N1"</span>, <span class="st">"inf_B"</span>, <span class="st">"other"</span><span class="op">)</span>,</span>
<span>  correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"h3n2"</span><span class="op">]</span>, <span class="va">prop_h3n2</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"h1n1"</span><span class="op">]</span>, <span class="va">prop_h1n1</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"infB"</span><span class="op">]</span>, <span class="va">prop_infB</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"other"</span><span class="op">]</span>, <span class="va">prop_other</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">prop_h3n2</span> <span class="op">-</span> <span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"h3n2"</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">prop_h1n1</span> <span class="op">-</span> <span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"h1n1"</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">prop_infB</span> <span class="op">-</span> <span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"infB"</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">prop_other</span> <span class="op">-</span> <span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"other"</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">subtyped_recovery</span>, digits <span class="op">=</span> <span class="fl">4</span>,</span>
<span>             caption <span class="op">=</span> <span class="st">"Subtyped pathogen structure parameter recovery"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Subtyped pathogen structure parameter recovery</caption>
<thead><tr class="header">
<th align="left">pathogen</th>
<th align="right">correlation</th>
<th align="right">rmse</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">inf_H3N2</td>
<td align="right">0.9960</td>
<td align="right">0.0104</td>
</tr>
<tr class="even">
<td align="left">inf_H1N1</td>
<td align="right">0.9970</td>
<td align="right">0.0158</td>
</tr>
<tr class="odd">
<td align="left">inf_B</td>
<td align="right">0.9958</td>
<td align="right">0.0095</td>
</tr>
<tr class="even">
<td align="left">other</td>
<td align="right">0.9909</td>
<td align="right">0.0187</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_data_subtyped</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">dates</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  true <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"h3n2"</span><span class="op">]</span>, <span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"h1n1"</span><span class="op">]</span>,</span>
<span>           <span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"infB"</span><span class="op">]</span>, <span class="va">true_props_subtyped</span><span class="op">[</span>, <span class="st">"other"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  estimated <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">prop_h3n2</span>, <span class="va">prop_h1n1</span>, <span class="va">prop_infB</span>, <span class="va">prop_other</span><span class="op">)</span>,</span>
<span>  pathogen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"H3N2"</span>, <span class="st">"H1N1"</span>, <span class="st">"Influenza B"</span>, <span class="st">"Other"</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">n_timepoints</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_data_subtyped</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">true</span>, color <span class="op">=</span> <span class="st">"True"</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimated</span>, color <span class="op">=</span> <span class="st">"Estimated"</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">pathogen</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"True"</span> <span class="op">=</span> <span class="st">"black"</span>, <span class="st">"Estimated"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Subtyped Pathogen Structure Parameter Recovery"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"True vs estimated proportions for influenza subtypes and other pathogens"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Proportion"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="parameter-recovery_files/figure-html/plot-subtyped-recovery-1.png" class="r-plt" width="672"></p>
<hr>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This document demonstrates that <code>EpiStrainDynamics</code>
successfully recovers known parameters from simulated data:</p>
<ol style="list-style-type: decimal">
<li>Parameter recovery tested across single, multiple, and subtyped
pathogen structures</li>
<li>Recovery evaluated using quantitative metrics (correlation, RMSE,
MAE) with defined tolerances</li>
<li>Multiple random seeds confirm consistent recovery regardless of
stochastic variation</li>
</ol>
<p><strong>Key findings:</strong></p>
<ul>
<li>Single pathogen temporal patterns: correlation &gt;0.95, good
credible interval coverage</li>
<li>Multiple pathogen proportions: correlation &gt;0.90, RMSE
&lt;0.05</li>
<li>Subtyped structure: successful recovery of complex influenza subtype
dynamics</li>
<li>Both random walk and p-spline methods show robust parameter
recovery</li>
<li>Results are consistent across different random seeds (CV
&lt;0.05)</li>
</ul>
<p>These tests provide confidence that the model is correctly specified
and the inference algorithms work as intended.</p>
<hr>
</div>
<div class="section level2">
<h2 id="session-information">Session Information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.5.2 (2025-10-31)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 24.04.3 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] dplyr_1.1.4                  ggplot2_4.0.1               </span></span>
<span><span class="co">#&gt; [3] EpiStrainDynamics_0.0.0.9000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] viridis_0.6.5         sass_0.4.10           generics_0.1.4       </span></span>
<span><span class="co">#&gt;  [4] anytime_0.3.12        digest_0.6.39         magrittr_2.0.4       </span></span>
<span><span class="co">#&gt;  [7] timechange_0.3.0      evaluate_1.0.5        grid_4.5.2           </span></span>
<span><span class="co">#&gt; [10] RColorBrewer_1.1-3    fastmap_1.2.0         jsonlite_2.0.0       </span></span>
<span><span class="co">#&gt; [13] pkgbuild_1.4.8        gridExtra_2.3         purrr_1.2.0          </span></span>
<span><span class="co">#&gt; [16] viridisLite_0.4.2     QuickJSR_1.8.1        scales_1.4.0         </span></span>
<span><span class="co">#&gt; [19] codetools_0.2-20      textshaping_1.0.4     jquerylib_0.1.4      </span></span>
<span><span class="co">#&gt; [22] cli_3.6.5             rlang_1.1.6           ellipsis_0.3.2       </span></span>
<span><span class="co">#&gt; [25] splines_4.5.2         withr_3.0.2           cachem_1.1.0         </span></span>
<span><span class="co">#&gt; [28] yaml_2.3.12           StanHeaders_2.32.10   tools_4.5.2          </span></span>
<span><span class="co">#&gt; [31] rstan_2.32.7          inline_0.3.21         parallel_4.5.2       </span></span>
<span><span class="co">#&gt; [34] rstantools_2.5.0      tsibble_1.1.6         vctrs_0.6.5          </span></span>
<span><span class="co">#&gt; [37] R6_2.6.1              lubridate_1.9.4       matrixStats_1.5.0    </span></span>
<span><span class="co">#&gt; [40] stats4_4.5.2          lifecycle_1.0.4       fs_1.6.6             </span></span>
<span><span class="co">#&gt; [43] ragg_1.5.0            pkgconfig_2.0.3       desc_1.4.3           </span></span>
<span><span class="co">#&gt; [46] pkgdown_2.2.0         RcppParallel_5.1.11-1 pillar_1.11.1        </span></span>
<span><span class="co">#&gt; [49] bslib_0.9.0           gtable_0.3.6          loo_2.8.0            </span></span>
<span><span class="co">#&gt; [52] glue_1.8.0            Rcpp_1.1.0            systemfonts_1.3.1    </span></span>
<span><span class="co">#&gt; [55] xfun_0.55             tibble_3.3.0          tidyselect_1.2.1     </span></span>
<span><span class="co">#&gt; [58] knitr_1.50            farver_2.1.2          bayesplot_1.15.0     </span></span>
<span><span class="co">#&gt; [61] htmltools_0.5.9       labeling_0.4.3        rmarkdown_2.30       </span></span>
<span><span class="co">#&gt; [64] compiler_4.5.2        S7_0.2.1</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Saras Windecker, Oliver Eales, James McCaw, Freya Shearer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
